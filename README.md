# onecover-nodeproxy

## Замер покрытия кода тестами 1С:Предприятия

proxy - Логирующий реверс-прокси для 1с  
cover - Конвертор логов proxy в формат [genericCaverage](https://docs.sonarqube.org/latest/analysis/generic-test/)  

### Хау ту

Редактируем `env.bat`  
Ставим зависимости для прокси `npm install`  
Запускаем сервер-сайд `server.bat`

* Дебагсервер 1с на порту `1550`

* Proxy на порту `3000`

* Конфигуратор с отладкой настроенной на `http://ipadr:3000`

Запускаем клиент `client.bat`

* Тонкий клиент с отлдакой настроенной на `http://ipadr:3000`

Запускаем замеры.  
Кликаем VA в клиенте.  
Останавливаем замеры.  
Логи должны накапливатся в `./log/project.log`

Запускаем `cover.bat`  
Подкладываем Сонару `genericCoverage.xml` из `./out`

## Клиент-сервер
Если с файловой все понятно, то в режиме клиент сервера все грустнее.
1. Есть имя базы отладки на кластере, которое в случае файловой всегда DefAllias, вот надо зайти в расширение и поменять там на то имя базы, которое используется для отладки. Обычно. это имя базы в кластере, но не всегда. Пароль для отладки не предусмотрен.
Расширение работает по принципу циклического перезапуска записи замеров. В VA НИЧЕГО не надо делать дополнительно. Просто подтягиваете расширение и все.
2. Надо в реестре прописать -debug -http /debugServerAddr localhost /debugServerPort 3000. иначе - будет работать только отладка клиента.
Далее, надо зайти в конфигуратор, который будет открываться и куда будет идти подключение и там в настройках отладки прописать этот порт 3000.
Обратить внимание, что надо выполнить такую последовательность действий:
    1. Остановить 1С службу
    2. Стартануть nodejs
    3. Открыть конфигуратор
    4. Стартовать VA с коммандной строки. Без параметров отладки, а уже старт тест клиента с VA должен быть с параметрами отладки.
    5. Запустить конвертацию и т.д.
Все это уже есть в файле server.bat. Не забыть поставить таймаут в дженкинсе, перед запуском 4 пункта.
3. При работе через ЕДТ - не забывайте, что нужен файл ConfigDumpInfo.xml, который при конвертации из EDT не создается, так что его надо выгрузить. 

Необходимо учесть, что включение замеров замедляет выполнение тестов, в 99% случаях - это не страшно, но могут быть ситуации, когда тесты падают на ровном месте, это говорит о том, что там надо ставить паузы.
